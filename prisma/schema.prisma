generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String                @id(map: "PK_a3ffb1c0c8416b9fc6f907b7433") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                    String                @unique(map: "UQ_97672ac88f789774dd47f7c8be3") @db.VarChar
  password                 String                @db.VarChar
  role                     users_role_enum       @default(CUSTOMER)
  firstName                String                @db.VarChar
  lastName                 String                @db.VarChar
  phone                    String?               @db.VarChar
  isEmailVerified          Boolean               @default(false)
  isActive                 Boolean               @default(true)
  lastLogin                DateTime?             @db.Timestamp(6)
  refreshToken             String?               @db.VarChar
  passwordResetToken       String?               @db.VarChar
  passwordResetExpires     DateTime?             @db.Timestamp(6)
  createdAt                DateTime              @default(now()) @db.Timestamp(6)
  updatedAt                DateTime              @default(now()) @updatedAt @db.Timestamp(6)
  profilePicture           String?               @db.VarChar
  emailVerificationToken   String?               @db.VarChar
  emailVerificationExpires DateTime?             @db.Timestamp(6)
  addresses                Address[]
  categories               Category[]            @relation("CategoryCreator")
  loginActivities          LoginActivity[]
  products                 Product[]
  preferences              UserPreferences?
  securitySettings         UserSecuritySettings?
  cart                     Cart?
  orders                   Order[]

  @@index([email], map: "IDX_97672ac88f789774dd47f7c8be")
  @@map("users")
}

model Address {
  id            String   @id(map: "PK_745d8f43d3af10ab8247465e450") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String   @db.Uuid
  label         String   @db.VarChar
  recipientName String   @db.VarChar
  phone         String   @db.VarChar
  address       String
  city          String   @db.VarChar
  postalCode    String?  @db.VarChar
  country       String   @default("Sénégal") @db.VarChar
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamp(6)
  region        String   @db.VarChar
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_95c93a584de49f0b0e13f753630")

  @@map("addresses")
}

model UserPreferences {
  id                 String   @id(map: "PK_e8cfb5b31af61cd363a6b6d7c25") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId             String   @unique(map: "UQ_b6202d1cacc63a0b9c8dac2abd4") @db.Uuid
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(true)
  pushNotifications  Boolean  @default(true)
  marketingEmails    Boolean  @default(false)
  language           String   @default("fr") @db.VarChar
  currency           String   @default("XOF") @db.VarChar
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamp(6)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_b6202d1cacc63a0b9c8dac2abd4")

  @@map("user_preferences")
}

model UserSecuritySettings {
  id                 String   @id(map: "PK_db3c1ccc2bca1958f353b59586d") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId             String   @unique(map: "UQ_19bc5149a55b8ffb9e710da3f5f") @db.Uuid
  profileVisibility  Boolean  @default(true)
  showEmail          Boolean  @default(true)
  showPhone          Boolean  @default(true)
  allowMessages      Boolean  @default(true)
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecret    String?  @db.VarChar
  emailNotifications Boolean  @default(true)
  loginAlerts        Boolean  @default(true)
  deviceManagement   Boolean  @default(true)
  sessionTimeout     Int      @default(30)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamp(6)
  user               User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_19bc5149a55b8ffb9e710da3f5f")

  @@map("user_security_settings")
}

model LoginActivity {
  id            String   @id(map: "PK_5e930c4a22ae21222fcae279d2a") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String   @db.Uuid
  ipAddress     String   @db.VarChar
  userAgent     String?  @db.VarChar
  device        String?  @db.VarChar
  browser       String?  @db.VarChar
  location      String?  @db.VarChar
  success       Boolean  @default(true)
  failureReason String?  @db.VarChar
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  user          User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_c377206365d1e5b49abc060a685")

  @@index([userId, createdAt], map: "IDX_91e18bd7cc41fb911e62d3dc22")
  @@index([userId], map: "IDX_c377206365d1e5b49abc060a68")
  @@map("login_activities")
}

model Category {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String     @db.VarChar
  slug        String     @unique @db.VarChar
  description String?
  image       String?    @db.VarChar
  parentId    String?    @db.Uuid
  createdById String?    @db.Uuid
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now()) @db.Timestamp(6)
  updatedAt   DateTime   @default(now()) @updatedAt @db.Timestamp(6)
  createdBy   User?      @relation("CategoryCreator", fields: [createdById], references: [id], onUpdate: NoAction)
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onUpdate: NoAction)
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sellerId         String           @db.Uuid
  categoryId       String           @db.Uuid
  name             String           @db.VarChar
  slug             String           @unique @db.VarChar
  description      String
  shortDescription String?
  sku              String?          @unique @db.VarChar
  brand            String?          @db.VarChar
  status           ProductStatus    @default(DRAFT)
  price            Decimal          @db.Decimal(10, 2)
  compareAtPrice   Decimal?         @db.Decimal(10, 2)
  costPrice        Decimal?         @db.Decimal(10, 2)
  weight           Decimal?         @db.Decimal(8, 2)
  dimensions       String?          @db.VarChar
  tags             String[]         @default([])
  isDigital        Boolean          @default(false)
  requiresShipping Boolean          @default(true)
  trackInventory   Boolean          @default(true)
  allowBackorder   Boolean          @default(false)
  createdAt        DateTime         @default(now()) @db.Timestamp(6)
  updatedAt        DateTime         @default(now()) @updatedAt @db.Timestamp(6)
  inventoryAlerts  InventoryAlert[]
  images           ProductImage[]
  stock            ProductStock?
  promotions       ProductPromotion[]
  cartItems        CartItem[]
  orderItems       OrderItem[]
  category         Category         @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  seller           User             @relation(fields: [sellerId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([sellerId])
  @@index([categoryId])
  @@index([slug])
  @@index([sku])
  @@index([brand])
  @@index([status])
  @@map("products")
}

model ProductImage {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId    String   @db.Uuid
  url          String   @db.VarChar
  cloudinaryId String?  @db.VarChar
  alt          String?  @db.VarChar
  order        Int      @default(0)
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @default(now()) @updatedAt @db.Timestamp(6)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId])
  @@index([productId, order])
  @@map("product_images")
}

model ProductStock {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId         String   @unique @db.Uuid
  quantity          Int      @default(0)
  reservedQuantity  Int      @default(0)
  lowStockThreshold Int      @default(10)
  location          String?  @db.VarChar
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamp(6)
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("product_stocks")
}

model InventoryAlert {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId   String   @db.Uuid
  threshold   Int
  isActive    Boolean  @default(true)
  notifyEmail Boolean  @default(true)
  notifySms   Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamp(6)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId])
  @@map("inventory_alerts")
}

enum users_role_enum {
  CUSTOMER
  SELLER
  ENTERPRISE
  ADMIN
  SUPER_ADMIN
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
}

model ProductPromotion {
  id            String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  productId     String        @db.Uuid
  title         String?       @db.VarChar
  description   String?       @db.Text
  discountType  PromotionType @default(PERCENTAGE)
  discountValue Decimal       @db.Decimal(10, 2)
  startDate     DateTime      @db.Timestamp(6)
  endDate       DateTime      @db.Timestamp(6)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now()) @db.Timestamp(6)
  updatedAt     DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([productId])
  @@index([isActive, startDate, endDate])
  @@map("product_promotions")
}

model Cart {
  id        String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String     @unique @db.Uuid
  createdAt DateTime   @default(now()) @db.Timestamp(6)
  updatedAt DateTime   @default(now()) @updatedAt @db.Timestamp(6)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  items     CartItem[]

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cartId    String   @db.Uuid
  productId String   @db.Uuid
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  MOBILE_MONEY
  CASH_ON_DELIVERY
  DIRECT_CONTACT
  CARD
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model Order {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId          String        @db.Uuid
  orderNumber     String        @unique @db.VarChar
  status          OrderStatus   @default(PENDING)
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  shipping        Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  shippingAddress String
  shippingCity    String        @db.VarChar
  shippingRegion  String        @db.VarChar
  shippingCountry String        @default("Sénégal") @db.VarChar
  shippingPostalCode String?    @db.VarChar
  recipientName   String        @db.VarChar
  recipientPhone  String        @db.VarChar
  notes           String?
  cancelledAt     DateTime?     @db.Timestamp(6)
  cancelledReason String?
  deliveredAt     DateTime?     @db.Timestamp(6)
  createdAt       DateTime      @default(now()) @db.Timestamp(6)
  updatedAt       DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  items           OrderItem[]
  payments        Payment[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId         String   @db.Uuid
  productId       String   @db.Uuid
  productName     String   @db.VarChar
  productSku      String?  @db.VarChar
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  discount        Decimal  @default(0) @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamp(6)
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product         Product  @relation(fields: [productId], references: [id], onUpdate: NoAction)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id                String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId           String        @db.Uuid
  method            PaymentMethod
  status            PaymentStatus @default(PENDING)
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("XOF") @db.VarChar
  paydunyaToken     String?       @unique @db.VarChar
  paydunyaInvoiceId String?       @unique @db.VarChar
  paydunyaReceiptUrl String?      @db.VarChar
  mobileMoneyNumber  String?      @db.VarChar
  mobileMoneyProvider String?     @db.VarChar
  transactionId     String?       @unique @db.VarChar
  failureReason     String?
  metadata          String?       @db.Text
  paidAt            DateTime?     @db.Timestamp(6)
  createdAt         DateTime      @default(now()) @db.Timestamp(6)
  updatedAt         DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orderId])
  @@index([status])
  @@index([paydunyaToken])
  @@index([paydunyaInvoiceId])
  @@index([transactionId])
  @@map("payments")
}
